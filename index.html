<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史建筑地图-苏州南通篇</title>
</head>
<body>
    <script src="../Cesium.js"></script>
    <style>
        @import url(../Widgets/widgets.css);
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
    </style>
    <div id="cesiumContainer"></div>
    <script>
	Cesium.Ion.defaultAccessToken ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3OGNjOGU5Ni00NzUyLTQ2MzYtYjNiMi1hNWU0NTcwOTZjMGEiLCJpZCI6MTg4ODI2LCJpYXQiOjE3MDQ4NDk3NTN9.jy2esjOUJ4h-BTxDFfVxv_i4UJlTAu9s2i_2j_hO_Hc';
        var viewer = new Cesium.Viewer('cesiumContainer',{
            animation:false, //动画控制，默认true
            baseLayerPicker:true,//地图切换控件(底图以及地形图)是否显示,默认显示true
            fullscreenButton:false,//全屏按钮,默认显示true
            geocoder:false,//地名查找,默认true
            timeline:false,//时间线,默认true
            vrButton:false,//双屏模式,默认不显示false
            homeButton:true,//主页按钮，默认true
            selectionIndicator:false,//选中元素显示,默认true
            navigationHelpButton:false,//导航帮助说明,默认true
            navigationInstructionsInitiallyVisible:false,
            automaticallyTrackDataSourceClocks:false,//自动追踪最近添加的数据源的时钟设置,默认true
            sceneModePicker : true,//是否显示地图2D2.5D3D模式
            sceneMode: 3,//指定地图影像显示2D
        });
		
		let [tiandiVecModel, tiandiImgModel] = getProviderViewModels();
		viewer.baseLayerPicker.viewModel.imageryProviderViewModels.unshift(
	    	tiandiVecModel
		);
		viewer.baseLayerPicker.viewModel.imageryProviderViewModels.unshift(
	    	tiandiImgModel
		);
		
        viewer.camera.flyTo({
            // fromDegrees()方法，将经纬度和高程转换为世界坐标
            destination:Cesium.Cartesian3.fromDegrees(120.62,31.30,600000.0)
        });
        let geojsonUrl = "geo.geojson"

        viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function(e) {
			e.cancel = true;  
			viewer.camera.flyTo({
				destination: Cesium.Rectangle.fromDegrees(120.62, 31.30, 600000.0)
			});
		});

        fetch(geojsonUrl)
            .then(response => response.json())
            .then((data) => {
                var entities = [];
                data.features.forEach(function (feature) {
                    var entity = featureToEntity(viewer, feature);
                    if (entity !== undefined && entity !== null) {
                        entities.push(entity);
                    }
                });
                // 添加所有Entities到场景中显示
                viewer.entities.add(entities);
        })

        // 将GeoJSON Feature转换为Cesium Entity
        function featureToEntity(viewer, feature) {
            var geometryType = feature.geometry.type;
            return pointToEntity(viewer, feature);
        }
        // Point类型的Geometry转换为Cesium Entity
        function pointToEntity(viewer, feature) {
            var position = Cesium.Cartesian3.fromDegrees(feature.geometry.coordinates[0], feature.geometry.coordinates[1]);
            var properties = feature.properties || {};
            let color = null
            if(properties.date === "清及以前"){
                color = Cesium.Color.PALETURQUOISE
            }else if(properties.date === "1900-1999"){
                color = Cesium.Color.NAVAJOWHITE
            }else{
                color = Cesium.Color.RED
            }
            var entity = viewer.entities.add({
                name : properties.name,
                description: "类别: " + properties.grade + "</br></br>" + 
                    "建筑年代: " + properties.date + "</br></br>" +  
                    "地址: " + properties.address + "</br></br>" + 
                    "公布时间: " + properties.year + "年",
                position : position,
                point : {
                    pixelSize : 8,
                    color : color
                }
            });
            return entity;
        }
		
		function getProviderViewModels() {
			const tiandiKey = "9db2df99c32d3060db0f701ce83618b2";       //天地图key，官网申请
			const baseUrl = 'http://t{s}.tianditu.gov.cn';
			//天地图
			let tiandiVec = new Cesium.UrlTemplateImageryProvider({
				subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
				url: baseUrl + '/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk='+tiandiKey
			});
			//天地图影像
			let tiandiImg = new Cesium.UrlTemplateImageryProvider({
				subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
				url: baseUrl + '/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk='+tiandiKey
			});
			//天地图标注
			let tiandiCva = new Cesium.UrlTemplateImageryProvider({
				subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
				url: baseUrl + '/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk='+tiandiKey
			});
			//天地图影像标注
			let tiandiCia = new Cesium.UrlTemplateImageryProvider({
				subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],
				url: baseUrl + '/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk='+tiandiKey
			});

			let tiandiVecModel = new Cesium.ProviderViewModel({
        		name: '天地图矢量',
        		category: '天地图矢量地图资源',
        		iconUrl: Cesium.buildModuleUrl('./Widgets/Images/ImageryProviders/openStreetMap.png'),
        		tooltip: 'WMTS 地图服务',
        		creationFunction: function () {
            		return [tiandiVec, tiandiCva];
        		}
    		});
    		let tiandiImgModel = new Cesium.ProviderViewModel({
        		name: '天地图影像',
        		category: '天地图影像地图资源',
        		iconUrl: Cesium.buildModuleUrl('./Widgets/Images/ImageryProviders/esriWorldImagery.png'),
        		tooltip: 'WMTS 影像服务',
        		creationFunction: function () {
            		return [tiandiImg, tiandiCva];
        		}
    		});
			return [tiandiVecModel, tiandiImgModel]
		}
    </script>
</body>
</html>
